# Makefile for creating the Matlab MEX function for the das3 implicit model
# This Makefile was formatted for Microsoft's NMAKE.EXE

# Makefile for das3

MEX = mex											# this should go to the mex.bat file in the current Matlab version
CC = "C:\Program Files\LLVM\bin\clang-cl.exe"		# clang compiler
# compiler options for C compiler
# remove /Ofast for fast compilation (30 sec) and slower execution
# add /Ofast for for slower compilation (20 min) and about 2x faster execution
CFLAGS=/nologo /w /Ofast

# uncomment the following line to build both mex functions (the S-function binary should be added here also)
all: das3mex.mexw64 das3steptest.mexw64	

# the first target is the actual mex function
das3mex.mexw64: das3mex.c das3mex.h das3_al.obj
		@echo Compiling das3mex.c...
		$(MEX) das3mex.c das3_al.obj

# the following is the compilation of C code generated by Autolev
das3_al.obj:	das3_al.c das3mex.h
		@echo Compiling C code generated by Autolev, may take some time...
		@echo Without /O2 option: 30 seconds, with /Ofast option: 25 minutes.
		$(CC) $(CFLAGS) /c das3_al.c
# $(MEX) -c das3_al.c		% this uses MinGW

# clean the raw C code generated by Autolev
das3_al.c: das3_al_raw.c autolevclean.exe
		@echo cleaning das3_al_raw.c to produce das3_al.c...
		autolevclean.exe

# make the program that cleans the Autolev C code
autolevclean.exe: autolevclean.c
		$(CC) $(CFLAGS) autolevclean.c
		
# make das3step.obj from das3mex.c (see #ifdef DAS3STEP in das3mex.c)
das3step.obj: das3mex.c das3mex.h 
#  		$(MEX) -c -DDAS3STEP das3mex.c
# following line to use the Gauss-Jordan solver (which is too slow, 6.2 ms per time step)
        $(MEX) -c -DDAS3STEP -DGAUSSJ das3mex.c
		del /q das3step.obj
		rename das3mex.obj das3step.obj

# make the das3step testing program.  the eventual S-function should be compiled in a similar way
# Matlab mex recognizes the -lmwlapack option to link with the LAPACK linear algebra functions
das3steptest.mexw64: das3steptest.c das3step.obj das3_al.obj
		$(MEX) das3steptest.c das3step.obj das3_al.obj -lmwlapack

# run Autolev on Ton's computer, when das3_al_raw.c is outdated
!IF "$(COMPUTERNAME)" == "LRI-102855"
das3_al_raw.c: das3.al contact.a sym_atan2.r
		"C:\Users\Ton\Documents\Software\Autolev\al.exe" das3.al >NUL
		del das3_al_raw.in				# .in file is generated by autolev but not needed
!ENDIF






